<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .nav-tabs .nav-link.active {
            font-weight: bold;
            background-color: #fff;
            border-bottom: 3px solid #0d6efd;
        }
        .tab-pane {
            padding: 20px 0;
        }
        .card {
            border: none;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Painel Administrativo</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <button class="btn btn-outline-light btn-sm" id="btnLogoutAdmin">Sair</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Abas de Navegação -->
        <ul class="nav nav-tabs" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="inquilinos-tab" data-bs-toggle="tab" data-bs-target="#inquilinos" type="button" role="tab">
                    Gerenciar Inquilinos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pendentes-tab" data-bs-toggle="tab" data-bs-target="#pendentes" type="button" role="tab">
                    Pagamentos Pendentes
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="efetuados-tab" data-bs-toggle="tab" data-bs-target="#efetuados" type="button" role="tab">
                    Pagamentos Efetuados
                </button>
            </li>
        </ul>

        <!-- Conteúdo das Abas -->
        <div class="tab-content" id="adminTabsContent">
            
            <!-- Aba 1: Gerenciar Inquilinos -->
            <div class="tab-pane fade show active" id="inquilinos" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Gerenciar Inquilinos</h4>
                        <div>
                            <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#modalNovoPagamento">
                                Registrar Pagamento
                            </button>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNovoInquilino">
                                Adicionar Inquilino
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>CPF</th>
                                        <th>Casa</th>
                                        <th>Aluguel</th>
                                        <th>Água</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaInquilinos">
                                    <!-- Dados serão preenchidos via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba 2: Pagamentos Pendentes -->
            <div class="tab-pane fade" id="pendentes" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">Pagamentos Pendentes</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Inquilino</th>
                                        <th>Casa</th>
                                        <th>Mês/Ano</th>
                                        <th>Valor</th>
                                        <th>Método</th>
                                        <th>Data Solicitação</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaPendentes">
                                    <!-- Dados serão preenchidos via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba 3: Pagamentos Efetuados -->
            <div class="tab-pane fade" id="efetuados" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Pagamentos Efetuados</h4>
                        <div>
                            <select class="form-select form-select-sm" id="filtroInquilino" style="width: auto; display: inline-block;">
                                <option value="">Todos os inquilinos</option>
                            </select>
                            <select class="form-select form-select-sm ms-2" id="filtroMes" style="width: auto; display: inline-block;">
                                <option value="">Todos os meses</option>
                                <option value="1">Janeiro</option>
                                <option value="2">Fevereiro</option>
                                <option value="3">Março</option>
                                <option value="4">Abril</option>
                                <option value="5">Maio</option>
                                <option value="6">Junho</option>
                                <option value="7">Julho</option>
                                <option value="8">Agosto</option>
                                <option value="9">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                            <select class="form-select form-select-sm ms-2" id="filtroAno" style="width: auto; display: inline-block;">
                                <option value="">Todos os anos</option>
                                <!-- Os anos serão carregados automaticamente via JavaScript -->
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Inquilino</th>
                                        <th>Casa</th>
                                        <th>Mês/Ano</th>
                                        <th>Valor</th>
                                        <th>Método</th>
                                        <th>Data Pagamento</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaEfetuados">
                                    <!-- Dados serão preenchidos via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Inquilino -->
    <div class="modal fade" id="modalNovoInquilino" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Inquilino</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formNovoInquilino">
                        <div class="mb-3">
                            <label for="nome" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" id="nome" required>
                        </div>
                        <div class="mb-3">
                            <label for="cpf" class="form-label">CPF</label>
                            <input type="text" class="form-control" id="cpf" required>
                        </div>
                        <div class="mb-3">
                            <label for="senha" class="form-label">Senha</label>
                            <input type="password" class="form-control" id="senha" required>
                        </div>
                        <div class="mb-3">
                            <label for="casa" class="form-label">Casa</label>
                            <select class="form-select" id="casa" required>
                                <option value="">Selecione a casa</option>
                                <option value="casa3">Casa 3</option>
                                <option value="casa3-101">Casa 3/101</option>
                                <option value="casa4">Casa 4</option>
                                <option value="casa4-101">Casa 4/101</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="aluguel" class="form-label">Valor do Aluguel</label>
                            <input type="number" class="form-control" id="aluguel" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="agua" class="form-label">Valor da Água</label>
                            <input type="number" class="form-control" id="agua" step="0.01" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnSalvarInquilino">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Registrar Pagamento Manual -->
    <div class="modal fade" id="modalNovoPagamento" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrar Pagamento Manual</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formNovoPagamento">
                        <div class="mb-3">
                            <label for="selectInquilinoPagamento" class="form-label">Inquilino</label>
                            <select class="form-select" id="selectInquilinoPagamento" required>
                                <option value="">Selecione o inquilino</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="novoMes" class="form-label">Mês</label>
                            <select class="form-select" id="novoMes" required>
                                <option value="">Selecione o mês</option>
                                <option value="1">Janeiro</option>
                                <option value="2">Fevereiro</option>
                                <option value="3">Março</option>
                                <option value="4">Abril</option>
                                <option value="5">Maio</option>
                                <option value="6">Junho</option>
                                <option value="7">Julho</option>
                                <option value="8">Agosto</option>
                                <option value="9">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="novoAno" class="form-label">Ano</label>
                            <input type="number" class="form-control" id="novoAno" min="2020" max="2030" value="2024" required>
                        </div>
                        <div class="mb-3">
                            <label for="novoValor" class="form-label">Valor Total</label>
                            <input type="number" class="form-control" id="novoValor" step="0.01" placeholder="Digite o valor total pago" required>
                        </div>
                        <div class="mb-3">
                            <label for="novoMetodo" class="form-label">Método de Pagamento</label>
                            <select class="form-select" id="novoMetodo" required>
                                <option value="">Selecione o método</option>
                                <option value="PIX">PIX</option>
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="Cartão">Cartão</option>
                                <option value="Transferência">Transferência</option>
                                <option value="Dinheiro/PIX">Dinheiro/PIX</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="novaDataPagamento" class="form-label">Data do Pagamento</label>
                            <input type="date" class="form-control" id="novaDataPagamento" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="checkAluguelAgua">
                            <label class="form-check-label" for="checkAluguelAgua">
                                Incluir valor da água no total
                            </label>
                        </div>
                        <div class="alert alert-info">
                            <small>
                                <strong>Informação:</strong> O sistema calculará automaticamente o valor do aluguel + água (se marcado) 
                                com base nos dados cadastrados do inquilino.
                            </small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnRegistrarPagamento">Registrar Pagamento</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Pagamento -->
    <div class="modal fade" id="modalEditarPagamento" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Pagamento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formEditarPagamento">
                        <div class="mb-3">
                            <label class="form-label">Inquilino</label>
                            <p class="form-control-plaintext" id="nomeInquilinoPagamento" style="font-weight: bold;"></p>
                        </div>
                        <div class="mb-3">
                            <label for="editMes" class="form-label">Mês</label>
                            <select class="form-select" id="editMes" required>
                                <option value="">Selecione o mês</option>
                                <option value="1">Janeiro</option>
                                <option value="2">Fevereiro</option>
                                <option value="3">Março</option>
                                <option value="4">Abril</option>
                                <option value="5">Maio</option>
                                <option value="6">Junho</option>
                                <option value="7">Julho</option>
                                <option value="8">Agosto</option>
                                <option value="9">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editAno" class="form-label">Ano</label>
                            <input type="number" class="form-control" id="editAno" min="2020" max="2030" required>
                        </div>
                        <div class="mb-3">
                            <label for="editValor" class="form-label">Valor</label>
                            <input type="number" class="form-control" id="editValor" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="editMetodo" class="form-label">Método de Pagamento</label>
                            <select class="form-select" id="editMetodo">
                                <option value="">Selecione o método</option>
                                <option value="PIX">PIX</option>
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="Cartão">Cartão</option>
                                <option value="Transferência">Transferência</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editDataPagamento" class="form-label">Data do Pagamento</label>
                            <input type="date" class="form-control" id="editDataPagamento">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnSalvarPagamento">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- SCRIPT DE PROTEÇÃO DA PÁGINA -->
    <script>
        // admin-auth-check.js - Proteção da página admin
        document.addEventListener('DOMContentLoaded', async function() {
            // Inicializar Firebase (use a mesma configuração do auth.js)
            const firebaseConfig = {
                apiKey: "sua-api-key",
                authDomain: "seu-projeto.firebaseapp.com",
                databaseURL: "https://seu-projeto.firebaseio.com",
                projectId: "seu-projeto",
                storageBucket: "seu-projeto.appspot.com",
                messagingSenderId: "seu-sender-id",
                appId: "seu-app-id"
            };
            
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }

            // Função para verificar se é admin
            async function checkIfAdmin(uid) {
                try {
                    const snapshot = await firebase.database().ref('administradores/' + uid).once('value');
                    return snapshot.exists();
                } catch (error) {
                    console.error("Erro ao verificar admin:", error);
                    return false;
                }
            }

            // Verificar autenticação
            async function checkAuth() {
                const adminAuth = localStorage.getItem('adminAuth');
                const adminUID = localStorage.getItem('adminUID');
                
                if (adminAuth && adminUID) {
                    const isAdmin = await checkIfAdmin(adminUID);
                    if (isAdmin) {
                        return true;
                    }
                }
                
                return false;
            }

            // Verificar se está autenticado como admin
            const isAuthenticated = await checkAuth();
            
            if (!isAuthenticated) {
                alert('Acesso não autorizado. Redirecionando para login...');
                window.location.href = 'admin-login.html';
                return;
            }
            
            // Se autenticado, configurar o botão de logout
            document.getElementById('btnLogoutAdmin').addEventListener('click', function() {
                firebase.auth().signOut();
                localStorage.removeItem('adminAuth');
                localStorage.removeItem('adminUID');
                window.location.href = 'admin-login.html';
            });

            // Configurar data atual no campo de data
            const dataAtual = new Date().toISOString().split('T')[0];
            const dataPagamentoInput = document.getElementById('novaDataPagamento');
            if (dataPagamentoInput) {
                dataPagamentoInput.value = dataAtual;
            }

            // Configurar filtros dos pagamentos efetuados
            const filtroMes = document.getElementById('filtroMes');
            const filtroAno = document.getElementById('filtroAno');
            const filtroInquilino = document.getElementById('filtroInquilino');
            
            if (filtroMes) {
                filtroMes.addEventListener('change', function() {
                    if (window.adminManager) {
                        window.adminManager.carregarPagamentosEfetuados();
                    }
                });
            }
            
            if (filtroAno) {
                filtroAno.addEventListener('change', function() {
                    if (window.adminManager) {
                        window.adminManager.carregarPagamentosEfetuados();
                    }
                });
            }
            
            if (filtroInquilino) {
                filtroInquilino.addEventListener('change', function() {
                    if (window.adminManager) {
                        window.adminManager.carregarPagamentosEfetuados();
                    }
                });
            }
            
            console.log('Admin autenticado. Carregando conteúdo...');
        });
    </script>

    <script src="js/auth.js"></script>
    <script src="js/admin.js"></script>
</body>
</html>
