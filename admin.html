<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel do Proprietário</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-light">

<div class="container py-5">
  <!-- LOGIN DO ADMIN -->
  <div id="adminLogin" class="card shadow mx-auto p-4" style="max-width: 400px;">
    <h4 class="text-center mb-3">Login do Proprietário</h4>
    <input type="email" id="adminEmail" class="form-control mb-2" placeholder="E-mail do admin">
    <input type="password" id="adminSenha" class="form-control mb-3" placeholder="Senha">
    <button id="btnAdminLogin" class="btn btn-primary w-100">Entrar</button>
  </div>

  <!-- PAINEL PRINCIPAL -->
  <div id="adminPainel" class="d-none">

    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3>Painel do Proprietário</h3>
      <button id="btnLogout" class="btn btn-outline-danger btn-sm">Sair</button>
    </div>

    <!-- FORM DE CADASTRO DE INQUILINOS -->
    <div class="card mb-4 p-4 shadow-sm">
      <h5 class="mb-3">Cadastrar novo inquilino</h5>
      <div class="row g-2">
        <div class="col-md-3">
          <input type="text" id="nome" class="form-control" placeholder="Nome">
        </div>
        <div class="col-md-2">
          <input type="text" id="cpf" class="form-control" placeholder="CPF (apenas números)">
        </div>
        <div class="col-md-3">
          <input type="text" id="endereco" class="form-control" placeholder="Endereço">
        </div>
        <div class="col-md-1">
          <input type="number" id="aluguel" class="form-control" placeholder="Aluguel">
        </div>
        <div class="col-md-1">
          <input type="number" id="agua" class="form-control" placeholder="Água">
        </div>
        <div class="col-md-2">
          <input type="password" id="senha" class="form-control" placeholder="Senha">
        </div>
        <div class="col-md-12 mt-2 text-end">
          <button id="btnCadastrar" class="btn btn-success">Cadastrar</button>
        </div>
      </div>
    </div>

    <!-- LISTA DE INQUILINOS -->
    <div class="card shadow-sm p-4 mb-4">
      <h5>Inquilinos Cadastrados</h5>
      <table class="table table-bordered mt-3">
        <thead>
          <tr>
            <th>Nome</th>
            <th>CPF</th>
            <th>Endereço</th>
            <th>Aluguel</th>
            <th>Água</th>
          </tr>
        </thead>
        <tbody id="listaInquilinos"></tbody>
      </table>
    </div>

    <!-- PAGAMENTOS PENDENTES -->
    <div class="card shadow-sm p-4">
      <h5>Pagamentos Pendentes</h5>
      <table class="table table-bordered mt-3">
        <thead>
          <tr>
            <th>Inquilino</th>
            <th>Mês</th>
            <th>Valor</th>
            <th>Forma</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="listaPendentes"></tbody>
      </table>
    </div>

  </div>
</div>

<!-- Firebase e scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="js/firebase.js"></script>

<script>
const loginDiv = document.getElementById("adminLogin");
const painelDiv = document.getElementById("adminPainel");

// LOGIN ADMIN
document.getElementById("btnAdminLogin").onclick = async () => {
  const email = document.getElementById("adminEmail").value;
  const senha = document.getElementById("adminSenha").value;

  try {
    await myAuth.loginAdmin(email, senha);

    // Espera o currentUser estar definido
    const user = firebase.auth().currentUser;
    if (!user) throw new Error("Usuário não logado ainda");

    // Agora sim, acesso liberado
    loginDiv.classList.add("d-none");
    painelDiv.classList.remove("d-none");

    carregarInquilinos();
    carregarPagamentosPendentes();
  } catch (e) {
    alert("Erro ao entrar: " + e.message);
  }
};

// LOGOUT
document.getElementById("btnLogout").onclick = async () => {
  await myAuth.logout();
  painelDiv.classList.add("d-none");
  loginDiv.classList.remove("d-none");
};

// CADASTRAR INQUILINO
document.getElementById("btnCadastrar").onclick = async () => {
  const nome = document.getElementById("nome").value;
  const cpf = document.getElementById("cpf").value;
  const endereco = document.getElementById("endereco").value;
  const aluguel = parseFloat(document.getElementById("aluguel").value);
  const agua = parseFloat(document.getElementById("agua").value);
  const senha = document.getElementById("senha").value;

  if (!nome || !cpf || !endereco || !aluguel || !senha) {
    alert("Preencha todos os campos obrigatórios!");
    return;
  }

  try {
    await myAuth.criarInquilino({ nome, cpf, endereco, aluguel, agua, senha });
    alert("Inquilino cadastrado com sucesso!");
    carregarInquilinos();
  } catch (e) {
    alert("Erro ao cadastrar: " + e.message);
  }
};

// LISTAR INQUILINOS
async function carregarInquilinos() {
  const lista = document.getElementById("listaInquilinos");
  lista.innerHTML = "<tr><td colspan='5'>Carregando...</td></tr>";
  try {
    const dados = await myDB.getTodosInquilinos();
    if (!dados) {
      lista.innerHTML = "<tr><td colspan='5'>Nenhum inquilino cadastrado</td></tr>";
      return;
    }
    lista.innerHTML = "";
    Object.entries(dados).forEach(([cpf, info]) => {
      lista.innerHTML += `
        <tr>
          <td>${info.nome}</td>
          <td>${cpf}</td>
          <td>${info.endereco}</td>
          <td>R$ ${info.aluguel.toFixed(2)}</td>
          <td>R$ ${info.agua.toFixed(2)}</td>
        </tr>
      `;
    });
  } catch (e) {
    alert("Erro ao carregar inquilinos: " + e.message);
  }
}

// LISTAR PAGAMENTOS PENDENTES
async function carregarPagamentosPendentes() {
  const lista = document.getElementById("listaPendentes");
  lista.innerHTML = "<tr><td colspan='5'>Carregando...</td></tr>";

  const dados = await myDB.getTodosInquilinos();
  if (!dados) {
    lista.innerHTML = "<tr><td colspan='5'>Nenhum pagamento pendente</td></tr>";
    return;
  }

  lista.innerHTML = "";
  for (const [cpf, info] of Object.entries(dados)) {
    const pagamentos = info.pagamentos || {};
    for (const [mes, pagamento] of Object.entries(pagamentos)) {
      if (pagamento.status === "pendente") {
        lista.innerHTML += `
          <tr>
            <td>${info.nome}</td>
            <td>${mes}</td>
            <td>R$ ${parseFloat(pagamento.valor).toFixed(2)}</td>
            <td>${pagamento.forma}</td>
            <td>
              <button class="btn btn-success btn-sm" onclick="aprovarPagamento('${cpf}','${mes}')">Aprovar</button>
              <button class="btn btn-danger btn-sm" onclick="rejeitarPagamento('${cpf}','${mes}')">Rejeitar</button>
            </td>
          </tr>
        `;
      }
    }
  }
}

// APROVAR PAGAMENTO
async function aprovarPagamento(cpf, mes) {
  await myDB.atualizarStatusPagamento(cpf, mes, "aprovado");
  carregarPagamentosPendentes();
}

// REJEITAR PAGAMENTO
async function rejeitarPagamento(cpf, mes) {
  await myDB.atualizarStatusPagamento(cpf, mes, "rejeitado");
  carregarPagamentosPendentes();
}
</script>

</body>
</html>
