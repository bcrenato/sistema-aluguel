<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel do Inquilino</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="css/style.css" />
</head>

<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <span class="navbar-brand">AluguelApp</span>
      <button id="btnLogout" class="btn btn-outline-light btn-sm">Sair</button>
    </div>
  </nav>

  <div class="container py-4">
    <h3 class="mb-4">Bem-vindo(a)</h3>

    <!-- DADOS DO INQUILINO -->
    <div class="card mb-4 p-3 shadow-sm">
      <h5>Dados da Casa</h5>
      <ul class="list-group mt-2">
        <li class="list-group-item">Nome: <span id="nome"></span></li>
        <li class="list-group-item">Endereço: <span id="endereco"></span></li>
        <li class="list-group-item">Aluguel: R$ <span id="aluguel"></span></li>
        <li class="list-group-item">Água: R$ <span id="agua"></span></li>
      </ul>
      <div class="mt-3">
        <button id="btnAbrirModal" class="btn btn-primary">Escolher forma de pagamento</button>
      </div>
    </div>

    <!-- HISTÓRICO DE PAGAMENTOS -->
    <div class="card p-3 shadow-sm">
      <h5>Histórico de Pagamentos</h5>
      <ul id="listaPagamentos" class="list-group mt-2">
        <li class="list-group-item">Carregando...</li>
      </ul>
    </div>
  </div>

  <!-- MODAL DE PAGAMENTO -->
  <div class="modal fade" id="modalPagamento" tabindex="-1" aria-labelledby="modalPagamentoLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalPagamentoLabel">Escolha a forma de pagamento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex gap-2 mb-3">
            <button id="btnPixModal" class="btn btn-success flex-fill">PIX: R$ <span id="valorPix"></span></button>
            <button id="btnDinheiroModal" class="btn btn-secondary flex-fill">Dinheiro: R$ <span id="valorDinheiro"></span></button>
          </div>
          <div id="mensagemMetodo" class="text-muted"></div>
        </div>
        <div class="modal-footer">
          <button type="button" id="btnCancelarMetodo" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" id="btnConfirmarMetodo" class="btn btn-primary" disabled>Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase e scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="js/firebase.js"></script>

  <script>
    let cpfLogado = null;
    let dadosInquilino = null;

    const nomeEl = document.getElementById("nome");
    const enderecoEl = document.getElementById("endereco");
    const aluguelEl = document.getElementById("aluguel");
    const aguaEl = document.getElementById("agua");
    const listaPagamentos = document.getElementById("listaPagamentos");

    // MODAL
    const btnAbrirModal = document.getElementById("btnAbrirModal");
    const btnPixModal = document.getElementById("btnPixModal");
    const btnDinheiroModal = document.getElementById("btnDinheiroModal");
    const btnConfirmarMetodo = document.getElementById("btnConfirmarMetodo");
    const mensagemMetodo = document.getElementById("mensagemMetodo");
    const valorPix = document.getElementById("valorPix");
    const valorDinheiro = document.getElementById("valorDinheiro");
    let metodoSelecionado = null;
    const modalPagamento = new bootstrap.Modal(document.getElementById("modalPagamento"));

    // LOGOUT
    document.getElementById("btnLogout").onclick = async () => {
      await myAuth.logout();
      window.location.href = "index.html";
    };

    // VERIFICAR LOGIN
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) return window.location.href = "index.html";
      cpfLogado = user.email.split("@")[0];
      await carregarDados();
    });

    // CARREGAR DADOS
    async function carregarDados() {
      dadosInquilino = await myDB.getInquilino(cpfLogado);
      if (!dadosInquilino) return alert("Dados não encontrados!");
      nomeEl.textContent = dadosInquilino.nome;
      enderecoEl.textContent = dadosInquilino.endereco;
      aluguelEl.textContent = parseFloat(dadosInquilino.aluguel).toFixed(2);
      aguaEl.textContent = parseFloat(dadosInquilino.agua || 0).toFixed(2);
      valorPix.textContent = (parseFloat(dadosInquilino.aluguel) + parseFloat(dadosInquilino.agua || 0)).toFixed(2);
      valorDinheiro.textContent = valorPix.textContent;
      carregarPagamentos();
    }

    // CARREGAR PAGAMENTOS
    async function carregarPagamentos() {
      listaPagamentos.innerHTML = "<li class='list-group-item'>Carregando...</li>";
      const pagamentos = dadosInquilino.pagamentos || {};
      listaPagamentos.innerHTML = "";

      if (Object.keys(pagamentos).length === 0) {
        listaPagamentos.innerHTML = "<li class='list-group-item'>Nenhum pagamento registrado</li>";
        return;
      }

      Object.entries(pagamentos).forEach(([mes, info]) => {
        listaPagamentos.innerHTML += `
          <li class="list-group-item">
            <strong>${mes}</strong> - R$ ${parseFloat(info.valor).toFixed(2)} - ${info.forma} - <em>${info.status}</em> (${info.dataSolicitacao})
          </li>
        `;
      });
    }

    // ABRIR MODAL
    btnAbrirModal.onclick = () => {
      metodoSelecionado = null;
      btnConfirmarMetodo.disabled = true;
      btnPixModal.disabled = false;
      btnDinheiroModal.disabled = false;
      mensagemMetodo.textContent = "";
      modalPagamento.show();
    };

    // SELECIONAR METODO
    btnPixModal.onclick = () => {
      metodoSelecionado = "PIX";
      btnPixModal.disabled = true;
      btnDinheiroModal.disabled = false;
      btnConfirmarMetodo.disabled = false;
      mensagemMetodo.textContent = `Você selecionou PIX. Confirme para enviar solicitação.`;
    };

    btnDinheiroModal.onclick = () => {
      metodoSelecionado = "Dinheiro";
      btnDinheiroModal.disabled = true;
      btnPixModal.disabled = false;
      btnConfirmarMetodo.disabled = false;
      mensagemMetodo.textContent = `Você selecionou Dinheiro. Confirme para enviar solicitação.`;
    };

    // CONFIRMAR METODO
    btnConfirmarMetodo.onclick = async () => {
      if (!metodoSelecionado) return;
      const mes = new Date().toLocaleString("pt-BR", { month: "long", year: "numeric" });
      await myDB.solicitarPagamento(cpfLogado, mes,
        parseFloat(dadosInquilino.aluguel) + parseFloat(dadosInquilino.agua || 0),
        metodoSelecionado
      );
      mensagemMetodo.textContent = "Aguarde a confirmação de pagamento pelo administrador.";
      btnConfirmarMetodo.disabled = true;
      carregarDados();
    };
  </script>
</body>
</html>
