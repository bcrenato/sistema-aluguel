<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel do Inquilino</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="css/style.css" />
</head>

<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <span class="navbar-brand">AluguelApp</span>
      <button id="btnLogout" class="btn btn-outline-light btn-sm">Sair</button>
    </div>
  </nav>

  <div class="container py-4">
    <h3 class="mb-4">Bem-vindo(a)</h3>

    <!-- DADOS DO INQUILINO -->
    <div class="card mb-4 p-3 shadow-sm">
      <h5>Dados da Casa</h5>
      <ul class="list-group mt-2">
        <li class="list-group-item">Nome: <span id="nome"></span></li>
        <li class="list-group-item">Endereço: <span id="endereco"></span></li>
        <li class="list-group-item">Aluguel: R$ <span id="aluguel"></span></li>
        <li class="list-group-item">Água: R$ <span id="agua"></span></li>
      </ul>

      <div class="mt-3 d-flex gap-2">
        <button id="btnPix" class="btn btn-success">Gerar Pix</button>
        <button id="btnDinheiro" class="btn btn-outline-secondary">Marcar pagamento em dinheiro</button>
      </div>
    </div>

    <!-- HISTÓRICO DE PAGAMENTOS -->
    <div class="card p-3 shadow-sm">
      <h5>Histórico de Pagamentos</h5>
      <ul id="listaPagamentos" class="list-group mt-2">
        <li class="list-group-item">Carregando...</li>
      </ul>
    </div>
  </div>

  <!-- Firebase e scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="js/firebase.js"></script>

  <script>
    const nomeEl = document.getElementById("nome");
    const enderecoEl = document.getElementById("endereco");
    const aluguelEl = document.getElementById("aluguel");
    const aguaEl = document.getElementById("agua");
    const listaPagamentos = document.getElementById("listaPagamentos");

    let cpfLogado = null;
    let dadosInquilino = null;

    // ========== VERIFICAR LOGIN ==========
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      // CPF do usuário é a parte antes do "@"
      cpfLogado = user.email.split("@")[0];
      await carregarDados();
    });

    // ========== CARREGAR DADOS ==========
    async function carregarDados() {
      dadosInquilino = await myDB.getInquilino(cpfLogado);
      if (!dadosInquilino) return alert("Dados não encontrados!");

      nomeEl.textContent = dadosInquilino.nome;
      enderecoEl.textContent = dadosInquilino.endereco;
      aluguelEl.textContent = parseFloat(dadosInquilino.aluguel).toFixed(2);
      aguaEl.textContent = parseFloat(dadosInquilino.agua || 0).toFixed(2);

      carregarPagamentos();
    }

    // ========== CARREGAR PAGAMENTOS ==========
    async function carregarPagamentos() {
      listaPagamentos.innerHTML = "<li class='list-group-item'>Carregando...</li>";
      const pagamentos = dadosInquilino.pagamentos || {};
      listaPagamentos.innerHTML = "";

      if (Object.keys(pagamentos).length === 0) {
        listaPagamentos.innerHTML = "<li class='list-group-item'>Nenhum pagamento registrado</li>";
        return;
      }

      Object.entries(pagamentos).forEach(([mes, info]) => {
        listaPagamentos.innerHTML += `
          <li class="list-group-item">
            <strong>${mes}</strong> - R$ ${parseFloat(info.valor).toFixed(2)} - ${info.forma} em ${info.data}
          </li>
        `;
      });
    }

    // ========== BOTÃO PIX ==========
    document.getElementById("btnPix").onclick = async () => {
      const valorTotal = parseFloat(dadosInquilino.aluguel) + parseFloat(dadosInquilino.agua || 0);
      alert(`Gerar PIX de R$ ${valorTotal.toFixed(2)}\n(implemente QR Code ou link real depois)`);
      // Registrar pagamento como Pix no mês atual
      const mes = new Date().toLocaleString("pt-BR", { month: "long", year: "numeric" });
      await myDB.registrarPagamento(cpfLogado, mes, valorTotal, "PIX");
      await carregarDados();
    };

    // ========== BOTÃO DINHEIRO ==========
    document.getElementById("btnDinheiro").onclick = async () => {
      const valorTotal = parseFloat(dadosInquilino.aluguel) + parseFloat(dadosInquilino.agua || 0);
      const mes = new Date().toLocaleString("pt-BR", { month: "long", year: "numeric" });
      await myDB.registrarPagamento(cpfLogado, mes, valorTotal, "Dinheiro");
      await carregarDados();
    };

    // ========== LOGOUT ==========
    document.getElementById("btnLogout").onclick = async () => {
      await myAuth.logout();
      window.location.href = "index.html";
    };
  </script>
</body>
</html>
