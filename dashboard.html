<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard do Inquilino</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-light">

<div class="container py-5">
  <!-- LOGIN INQUILINO -->
  <div id="loginDiv" class="card shadow mx-auto p-4" style="max-width: 400px;">
    <h4 class="text-center mb-3">Login do Inquilino</h4>
    <input type="text" id="cpfInput" class="form-control mb-2" placeholder="CPF">
    <input type="password" id="senhaInput" class="form-control mb-3" placeholder="Senha">
    <button id="btnLogin" class="btn btn-primary w-100">Entrar</button>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboardDiv" class="d-none">

    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3>Bem-vindo, <span id="nomeUsuario"></span></h3>
      <button id="btnLogout" class="btn btn-outline-danger btn-sm">Sair</button>
    </div>

    <!-- Botão Abrir Modal de Pagamento -->
    <div class="mb-4">
      <button id="btnAbrirModal" class="btn btn-success">Pagar Aluguel</button>
    </div>

    <!-- HISTÓRICO DE PAGAMENTOS -->
    <div class="card shadow-sm p-4">
      <h5>Histórico de Pagamentos</h5>
      <table class="table table-bordered mt-3">
        <thead>
          <tr>
            <th>Mês</th>
            <th>Valor</th>
            <th>Forma</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="historicoPagamentos"></tbody>
      </table>
    </div>

  </div>
</div>

<!-- MODAL DE PAGAMENTO -->
<div class="modal fade" id="modalPagamento" tabindex="-1" aria-labelledby="modalPagamentoLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalPagamentoLabel">Escolha a forma de pagamento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <!-- BOTÕES DE OPÇÃO -->
        <div class="d-flex gap-2 mb-3" id="opcoesPagamento">
          <button id="btnPixModal" class="btn btn-success flex-fill">PIX: R$ <span id="valorPix"></span></button>
          <button id="btnDinheiroModal" class="btn btn-secondary flex-fill">Dinheiro: R$ <span id="valorDinheiro"></span></button>
        </div>

        <!-- QR CODE PIX -->
        <div id="pixContainer" class="text-center mb-3" style="display:none;">
          <div id="qrCode"></div>
          <button id="btnCopiarPix" class="btn btn-outline-primary btn-sm mt-2">Copiar código PIX</button>
        </div>

        <div id="mensagemMetodo" class="text-muted"></div>
      </div>
      <div class="modal-footer">
        <button type="button" id="btnCancelarMetodo" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" id="btnConfirmarMetodo" class="btn btn-primary" disabled>Confirmar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="js/firebase.js"></script>

<script>
let dadosInquilino = null;
let cpfLogado = null;

// LOGIN INQUILINO
document.getElementById("btnLogin").onclick = async () => {
  const cpf = document.getElementById("cpfInput").value;
  const senha = document.getElementById("senhaInput").value;
  const emailFake = `${cpf}@aluguelapp.com`;

  try {
    await myAuth.loginInquilino(cpf, senha);
    cpfLogado = cpf;
    dadosInquilino = await myDB.getInquilino(cpf);
    document.getElementById("nomeUsuario").textContent = dadosInquilino.nome;
    document.getElementById("loginDiv").classList.add("d-none");
    document.getElementById("dashboardDiv").classList.remove("d-none");
    carregarHistorico();
  } catch (e) {
    alert("Erro ao entrar: " + e.message);
  }
};

// LOGOUT
document.getElementById("btnLogout").onclick = async () => {
  await myAuth.logout();
  document.getElementById("dashboardDiv").classList.add("d-none");
  document.getElementById("loginDiv").classList.remove("d-none");
};

// CARREGAR HISTÓRICO DE PAGAMENTOS
async function carregarHistorico() {
  const tbody = document.getElementById("historicoPagamentos");
  tbody.innerHTML = "";
  const pagamentos = dadosInquilino.pagamentos || {};
  for (const [mes, info] of Object.entries(pagamentos)) {
    tbody.innerHTML += `
      <tr>
        <td>${mes}</td>
        <td>R$ ${parseFloat(info.valor).toFixed(2)}</td>
        <td>${info.forma}</td>
        <td>${info.status}</td>
      </tr>
    `;
  }
}

// -----------------------------------------------
// MODAL DE PAGAMENTO
// -----------------------------------------------
const btnAbrirModal = document.getElementById("btnAbrirModal");
const btnPixModal = document.getElementById("btnPixModal");
const btnDinheiroModal = document.getElementById("btnDinheiroModal");
const btnConfirmarMetodo = document.getElementById("btnConfirmarMetodo");
const mensagemMetodo = document.getElementById("mensagemMetodo");
const pixContainer = document.getElementById("pixContainer");
const qrCodeDiv = document.getElementById("qrCode");
const btnCopiarPix = document.getElementById("btnCopiarPix");
const valorPix = document.getElementById("valorPix");
const valorDinheiro = document.getElementById("valorDinheiro");

let metodoSelecionado = null;
const modalPagamento = new bootstrap.Modal(document.getElementById("modalPagamento"));
const valorTotal = parseFloat(dadosInquilino?.aluguel || 0) + parseFloat(dadosInquilino?.agua || 0);
valorPix.textContent = valorTotal.toFixed(2);
valorDinheiro.textContent = valorTotal.toFixed(2);

// Função para gerar código PIX dinâmico
function gerarPixCode(inquilino, valor) {
  const hoje = new Date();
  const mes = hoje.toLocaleString("pt-BR", { month: "long" });
  const primeiroNome = inquilino.split(" ")[0];
  const identificador = `AluguelJP${primeiroNome}${mes}`;
  const pixCode = `00020126330014BR.GOV.BCB.PIX0111023198587845204000053039865802BR59${inquilino.length}${inquilino}6009Nilopolis62${identificador.length}${identificador}6304D211`;
  return pixCode;
}

// Abrir modal
btnAbrirModal.onclick = () => {
  metodoSelecionado = null;
  btnConfirmarMetodo.disabled = true;
  btnPixModal.disabled = false;
  btnDinheiroModal.disabled = false;
  btnPixModal.style.display = "inline-block";
  btnDinheiroModal.style.display = "inline-block";
  pixContainer.style.display = "none";
  qrCodeDiv.innerHTML = "";
  mensagemMetodo.textContent = "";
  modalPagamento.show();
};

// Selecionar PIX
btnPixModal.onclick = () => {
  metodoSelecionado = "PIX";
  btnPixModal.disabled = true;
  btnDinheiroModal.style.display = "none";
  btnConfirmarMetodo.disabled = false;
  mensagemMetodo.textContent = "Você selecionou PIX. Confirme para enviar solicitação.";
  pixContainer.style.display = "block";
  qrCodeDiv.innerHTML = "";

  const pixString = gerarPixCode(dadosInquilino.nome, valorTotal);

  new QRCode(qrCodeDiv, { text: pixString, width: 200, height: 200 });

  btnCopiarPix.onclick = () => {
    navigator.clipboard.writeText(pixString);
    alert("Código PIX copiado!");
  };
};

// Selecionar Dinheiro
btnDinheiroModal.onclick = () => {
  metodoSelecionado = "Dinheiro";
  btnDinheiroModal.disabled = true;
  btnPixModal.style.display = "none";
  pixContainer.style.display = "none";
  btnConfirmarMetodo.disabled = false;
  mensagemMetodo.textContent = "Você selecionou Dinheiro. Confirme para enviar solicitação.";
};

// Confirmar método
btnConfirmarMetodo.onclick = async () => {
  if (!metodoSelecionado) return;
  const mes = new Date().toLocaleString("pt-BR", { month: "long", year: "numeric" });
  await myDB.solicitarPagamento(cpfLogado, mes, valorTotal, metodoSelecionado);
  mensagemMetodo.textContent = "Aguarde a confirmação de pagamento pelo administrador.";
  btnConfirmarMetodo.disabled = true;
  carregarHistorico();
};
</script>

</body>
</html>
